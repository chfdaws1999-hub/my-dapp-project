<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My dApp – Portfolio Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{--bg:#0b0e13;--card:#121721;--ink:#e6e9ef;--muted:#9aa4b2;--pri:#0ea5e9;--ok:#22c55e;--bad:#ef4444;--warn:#f59e0b}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Arial}
  header{padding:14px 16px;border-bottom:1px solid #1f2937;display:flex;gap:10px;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:16px;font-weight:700}
  .grid{display:grid;gap:12px;padding:14px}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:12px}
  label{display:block;margin:8px 0 6px;color:var(--muted);font-size:12px}
  input,textarea,select{width:100%;background:#0f1420;color:var(--ink);border:1px solid #1f2937;border-radius:10px;padding:10px 12px}
  .row{display:flex;gap:8px;align-items:center}
  .row>*{flex:1}
  button{background:#1f2937;border:1px solid #303946;color:#e8eef7;border-radius:12px;padding:10px 14px;cursor:pointer}
  button.pri{background:var(--pri);border-color:#0284c7;color:#001018;font-weight:700}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,Consolas,monospace}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .hide{display:none}
</style>
</head>
<body>
<header>
  <div><h1>Portfolio Dashboard</h1><div class="muted" id="netInfo">ไม่เชื่อมต่อ</div></div>
  <button id="btnConnect" class="pri">เชื่อม MetaMask</button>
</header>

<div class="grid">

  <section class="card">
      <div class="muted">Address ของฉัน</div>
      <div id="me" class="mono">-</div>
      <div class="muted" style="margin-top:8px;">สถานะสมาชิก</div>
      <div id="membershipStatus">ยังไม่ได้ตรวจสอบ</div>
  </section>

  <section class="card">
    <h3>โหลดข้อมูลโทเคน</h3>
    <div class="row">
      <input id="tokenAddressInput" placeholder="วาง Contract Address ของโทเคนที่นี่..." />
      <button id="btnLoadToken" class="pri">โหลด</button>
    </div>
  </section>

  <section id="tokenSection" class="card hide">
    <div class="flex-between">
      <h3 id="tokenName">ชื่อโทเคน ($SYMBOL)</h3>
      <div class="muted mono" id="tokenAddressDisplay"></div>
    </div>
    
    <div class="row" style="margin-top:10px">
      <div class="card" style="flex:1">
        <div class="muted">ยอดคงเหลือ</div>
        <div id="tokenBalance" style="font-size: 20px; font-weight: bold;">-</div>
      </div>
      <div class="card" style="flex:1">
        <div class="muted">Total Supply</div>
        <div id="totalSupply">-</div>
      </div>
    </div>

    <h3 style="margin-top:14px">โอนโทเคน</h3>
    <div class="row">
      <input id="transferTo" placeholder="Address ปลายทาง 0x..." />
      <input id="transferAmount" placeholder="จำนวน" />
    </div>
    <div class="row" style="margin-top:8px;">
      <button id="btnTransfer" class="ok">โอน</button>
    </div>
  </section>

  <section class="card">
    <div class="flex-between">
      <div>Console</div>
      <button id="clear">clear</button>
    </div>
    <div id="log" class="mono" style="white-space:pre-wrap;max-height:220px;overflow:auto"></div>
  </section>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const log = (m)=>{$('log').textContent += (typeof m==='string'? m: JSON.stringify(m)) + "\n";}
$('clear').onclick = ()=>$('log').textContent='';

let provider, signer, me;
let currentTokenContract, currentTokenDecimals;

// --- ส่วนจัดการ Wallet และ สมาชิก ---
$('btnConnect').onclick = async()=>{
  if(!window.ethereum){alert('กรุณาติดตั้ง MetaMask'); return;}
  await ethereum.request({method:'eth_requestAccounts'});
  provider = new ethers.providers.Web3Provider(window.ethereum);
  signer = provider.getSigner();
  me = await signer.getAddress();
  const net = await provider.getNetwork();
  $('netInfo').textContent = `เชื่อมต่อ: chainId=${net.chainId} | ${net.name}`;
  $('me').textContent = me;
  log('Connected: '+me);
  // await checkAndShowMembershipStatus(); // <-- หากต้องการใช้ระบบสมาชิก ให้เปิดส่วนนี้
};

// --- ส่วนจัดการโทเคน ---
const tokenAbi = [
  {"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"type":"function"},
  {"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"type":"function"},
  {"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"type":"function"},
  {"constant":true,"inputs":[{"name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"type":"function"},
  {"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"type":"function"},
  {"constant":false,"inputs":[{"name":"to","type":"address"},{"name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"type":"function"}
];

$('btnLoadToken').onclick = async()=>{
  if(!provider){ alert('กรุณาเชื่อมต่อ Wallet ก่อน'); return; }
  const tokenAddress = $('tokenAddressInput').value.trim();
  if(!ethers.utils.isAddress(tokenAddress)){ alert('Address ของโทเคนไม่ถูกต้อง'); return; }

  log(`กำลังโหลดข้อมูลโทเคน: ${tokenAddress}`);
  try {
    currentTokenContract = new ethers.Contract(tokenAddress, tokenAbi, provider);

    // ดึงข้อมูลพื้นฐานของโทเคน
    const [name, symbol, decimals, totalSupply, balance] = await Promise.all([
      currentTokenContract.name(),
      currentTokenContract.symbol(),
      currentTokenContract.decimals(),
      currentTokenContract.totalSupply(),
      currentTokenContract.balanceOf(me)
    ]);
    
    currentTokenDecimals = decimals;

    // แสดงผลบนหน้าเว็บ
    $('tokenName').textContent = `${name} ($${symbol})`;
    $('tokenAddressDisplay').textContent = tokenAddress;
    $('tokenBalance').textContent = ethers.utils.formatUnits(balance, decimals);
    $('totalSupply').textContent = ethers.utils.formatUnits(totalSupply, decimals);
    
    $('tokenSection').classList.remove('hide');
    log('โหลดข้อมูลสำเร็จ');
  } catch (error) {
    alert('ไม่สามารถโหลดข้อมูลโทเคนได้ อาจเป็น Address ที่ไม่ถูกต้อง หรืออยู่ผิดเครือข่าย');
    log('Error loading token: ' + error.message);
    $('tokenSection').classList.add('hide');
  }
};

$('btnTransfer').onclick = async() => {
    if(!signer || !currentTokenContract){ alert('กรุณาโหลดข้อมูลโทเคนและเชื่อมต่อ Wallet ก่อน'); return; }
    const to = $('transferTo').value.trim();
    const amount = $('transferAmount').value.trim();
    if(!ethers.utils.isAddress(to)){ alert('Address ปลายทางไม่ถูกต้อง'); return; }
    if(isNaN(amount) || amount <= 0){ alert('จำนวนไม่ถูกต้อง'); return; }

    try {
        const amountWei = ethers.utils.parseUnits(amount, currentTokenDecimals);
        const tokenWithSigner = currentTokenContract.connect(signer);
        const tx = await tokenWithSigner.transfer(to, amountWei);
        log(`กำลังส่งธุรกรรมโอน... Hash: ${tx.hash}`);
        await tx.wait();
        log('โอนสำเร็จ!');
        // โหลดข้อมูลยอดเงินใหม่
        $('btnLoadToken').click();
    } catch (error) {
        alert('การโอนล้มเหลว');
        log('Transfer error: ' + error.message);
    }
}
</script>
</body>
</html>
